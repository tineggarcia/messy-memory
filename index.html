<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name=“description” content='Messy Memory, a different kind of memory game, memorise cards and position'>
    <meta name="keywords" content="Memory game, mario memory game">

    <!--Fontawesome and Google Fonts link -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Raleway%7CRighteous" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="assets/css/style3.css">
    <title>Messy Memory Game</title>
</head>
<script>
    let myModal;
    let modalDetails = "";
    // ["How to play",
    //     "\nTo play, wait for timer to finish. " +
    //     "\nDrag images to their original position. " +
    //     "\nScore will be based on total number of images in their original position!" +
    //     "\nPress 'Help Me' to mark images already in correct position(max 3)."];

    let array = [1, 2, 3, 4, 5, 6,7,8,9];
    let shuffledArray = array.sort((a, b) => 0.5 - Math.random());

    var game_level="expert";

    var gameOnGoing=false;

    function initGame() {
        clearImageDivs();
        var lastPerfectScoree = localStorage.getItem("last_perfect_scoree");
        document.getElementById("lastPerfectScoree").innerHTML=lastPerfectScoree;
    }

    function touchMove(e, image) {
        var touchLocation = e.targetTouches[0];

        // assign box new coordinates based on the touch.
        image.style.left = touchLocation.pageX + 'px';
        image.style.top = touchLocation.pageY + 'px';
    }

    function touchEnd(e,image) {
        // current box position.
        var x = parseInt(image.x);
        var y = parseInt(image.y);

        var endTarget = document.elementFromPoint(x, y);
        if (endTarget.id.startsWith("expert_image")) {
            swapParent(e.target,endTarget);
        }
    }

    function attachEventListeners() {
        var images = document.querySelectorAll(".img_container>img");
        for (let image of images) {
            image.draggable = true;

            image.addEventListener('touchstart', {}, {passive:true});
            image.addEventListener('touchmove', function (e) {
                var touchLocation = e.targetTouches[0];

                // assign box new coordinates based on the touch.
                image.style.left = touchLocation.pageX + 'px';
                image.style.top = touchLocation.pageY + 'px';
            },{passive:true});

            image.addEventListener('touchend', function (e) {
                var x = parseInt(image.style.left);
                var y = parseInt(image.style.top);
                var endTarget = document.elementFromPoint(x, y);
                if (endTarget.id.startsWith("expert_image") && gameOnGoing) {
                    swapParent(e.target,endTarget);
                }
            },{passive:true});
        }

        var helpMeButton = document.getElementById("helpMeButton");
        helpMeButton.addEventListener("click", helpMe, {once:true});

    }
    function removeEventListeners() {
        var images = document.querySelectorAll(".img_container>img");
        for (let image of images) {
            image.draggable = false;
            image.removeEventListener('touchstart', {}, {passive:true});
            image.removeEventListener('touchmove', function (e) {
                var touchLocation = e.targetTouches[0];

                // assign box new coordinates based on the touch.
                image.style.left = touchLocation.pageX + 'px';
                image.style.top = touchLocation.pageY + 'px';
            },{passive:true});

            image.removeEventListener('touchend', function (e) {
                var x = parseInt(image.style.left);
                var y = parseInt(image.style.top);
                var endTarget = document.elementFromPoint(x, y);
                if (endTarget.id.startsWith("expert_image")) {
                    swapParent(e.target,endTarget);
                }
            },{passive:true});
        }

        var helpMeButton = document.getElementById("helpMeButton");
        helpMeButton.removeEventListener("click", helpMe, {once:true});

        var startButton = document.getElementById("startGameButton");
        startButton.addEventListener("click",startGame);
    }

    document.addEventListener('DOMContentLoaded', function () {

        initGame();

        var startButton = document.getElementById("startGameButton");
        startButton.addEventListener("click", startGame);

        myModal = document.getElementById('myModal')
        myModal.addEventListener('show.bs.modal', function (event) {
            var title = modalDetails[0];
            var modalMessage = modalDetails[1];
            var buttonAction = modalDetails[2];

            var modalTitle = myModal.querySelector('.modal-title');
            var modalBodyInput = myModal.querySelector('.modal-body');
            var modalCloseButton = myModal.querySelector('#modalCloseButton');

            modalTitle.textContent = title;
            modalBodyInput.textContent = modalMessage;
        })

        let firstLand = sessionStorage.getItem("first_land");
        if (firstLand != "N") {
            firstLand="N";
            sessionStorage.setItem("first_land",firstLand);
            landingModal = new bootstrap.Modal(document.getElementById('myModal'), {});
            showInfo();
        }

    });

    function startGame() {

        modalDetails=["New Game","Remember the images and their position!!!"];
        showModalInfo();

        shuffledArray = array.sort((a, b) => 0.5 - Math.random());

        for (let i=0; i<shuffledArray.length; i++) {
            let image_div = document.getElementById("div_expert_image" + (i+1));
            let imgElem = document.getElementById(game_level + "_image"+ (i+1));
            imgElem.src = "assets/images/image" + shuffledArray[i] + ".webp";
            image_div.appendChild(imgElem);
        }

        var startButton = document.getElementById("startGameButton");
        startButton.removeEventListener("click", startGame);

        var countTimer = 15;
        var hasStarted = false;
        var newTimer = 23;

        var gametimer = setInterval(function() {
            // Update the count down every 1 second
            if (countTimer>=0) {
                document.getElementById("timer").innerHTML = countTimer;
            }

            if (countTimer <= 0 && countTimer>-2) {
                shuffleImageDivs();
            }
            if (countTimer==-2) {
                gameOnGoing=true;
                modalDetails=["Ready","Time is running out!  Start rearranging the images!!!"];
                showModalInfo();
                hasStarted=true;
                attachEventListeners();
            }
            if (hasStarted) {
                if (newTimer<21) {
                    document.getElementById("timer").innerHTML = newTimer;
                }
                newTimer--;
            }
            if (newTimer <0) {
                gameOnGoing=false;
                clearInterval(gametimer);
                removeEventListeners();
                checkOk();
            }
            countTimer--;
        }, 1000);
    }

    function shuffleImageDivs() {
        let reshuffleArray = array.sort((a, b) => 0.5 - Math.random());
        for (let i=0;i<array.length;i++) {
            let image_div = document.getElementById("div_" + game_level + "_image"+(i+1));
            image_div.appendChild(document.getElementById("div_" + game_level + "_image" + (reshuffleArray[i])).firstElementChild);
        }
    }

    function clearImageDivs() {
        for (let i=0; i<array.length; i++) {
            let imgElem = document.getElementById(game_level + "_image"+ (i+1));
            imgElem.src = "assets/images/mushroom.webp";
        }
    }

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
        ev.dataTransfer.setData("parent",ev.target.parentElement.id);
    }

    function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        swapParent(document.getElementById(data),ev.target);
    }

    function swapParent(swap1, swap2) {
        var source = swap1.parentElement;
        var target = swap2.parentElement;
        if (!(swap1.src.indexOf("ok_image")>0 || swap2.src.indexOf("ok_image")>0)) {
            target.appendChild(swap1);
            source.appendChild(swap2);
        }
    }

    function helpMe() {
        const parentElement = document.querySelector("#" + game_level + "_level");
        var images = parentElement.querySelectorAll("img");

        let helpCounter = 0;
        for (let image of images) {
            if (image.parentElement.id.endsWith(image.id) && helpCounter < 3)  {
                image.src = image.src.replace("images/image","images/ok_image");
                helpCounter++;
            }
        }
    }

    function checkOk() {
        var correctAnswer = 0;
        var check=true;

        const parentElement = document.querySelector("#" + game_level + "_level");
        var images = parentElement.querySelectorAll("img");

        for (let image of images) {
            if (!(image.parentElement.id.endsWith(image.id))) {
                check=false;
            } else {
                correctAnswer++;
                image.src = image.src.replace("images/image","images/ok_image");
            }
        }

        if (check) {
            let high_score = new bootstrap.Modal(document.getElementById('highscoremodal'));
            high_score.show();
        } else {
            modalDetails=["Well Done!!!","Your score is " + correctAnswer];
            showModalInfo();
        }
        return correctAnswer;
    }

    function showModalInfo() {
        var modal1 = new bootstrap.Modal(document.getElementById('myModal'), {});
        modal1.show();
    }

    function setLastPerfectScore(){
        var initials = document.getElementById("initials").value;
        if (initials!=null) {
            localStorage.setItem("last_perfect_scoree", initials);
            document.getElementById("lastPerfectScoree").innerHTML=initials;
            let high_score = bootstrap.Modal(document.getElementById('highscoremodal'));
            high_score.hide();
            return false;
        } else {
            return false;
        }
    }

    function showInfo(){
        // modalDetails = ["How to play","To play, wait for timer to finish. Drag images to their original position. Score will be based on total number of images in their original position!"];
        modalDetails =
                ["How to play",
                    "To play, wait for timer to finish.  " +
                    "Drag images to their original position.  " +
                    "Score will be based on total number of images in their original position!  " +
                    "Press 'Help Me' to mark maximum 3 images that already in correct position(single use only)."];
        landingModal.show();
    }

</script>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-1 col-lg-1">
        </div>
        <div class="col-12 col-md-10 col-lg-10">
            <div class="container">
                <div class="row">
                    <div class="col-lg-1 col-xl-2">
                    </div>

                    <div class="col-12 col-lg-10 col-xl-8">
                        <div class="container">
                            <div class="row">
                                <div class="col-2 col-sm-3 info-container bg-warning">
                                    <div id="top" class="card-body">Top Scoree</div>
                                    <div id="lastPerfectScoree" class="card-body">Top</div>
                                </div>
                                <div class="col-8 col-sm-6">
                                    <img class="img-thumbnail mx-auto d-block" src="assets/images/messymemlogobrown.webp"></img>
                                </div>
                                <div class="col-2 col-sm-3 info-container bg-warning">
                                    <div id="timer" class="card-body">?</div>
                                </div>
                            </div>
                        </div>

                        <div class="red-container">
                            <div class="container">
                                <div class="row">
                                    <div class="col-lg-1">
                                    </div>

                                    <div id="expert_level" class="col-12 col-md-12 col-lg-10">
                                        <div class="row expert_drop_div">
                                            <div id="div_expert_image1" class="col-4 img_container expert">
                                                <img id="expert_image1" class="img-thumbnail mx-auto d-block" draggable="false" alt="4" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"/>
                                            </div>
                                            <div id="div_expert_image2" class="col-4 img_container expert">
                                                <img id="expert_image2" class="img-thumbnail mx-auto d-block" draggable="false" alt="4" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"/>
                                            </div>
                                            <div id="div_expert_image3" class="col-4 img_container expert">
                                                <img id="expert_image3" class="img-thumbnail mx-auto d-block" draggable="false" alt="4" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"/>
                                            </div>
                                        </div>
                                        <div class="row expert_drop_div">
                                            <div id="div_expert_image4" class="col-4 img_container expert">
                                                <img id="expert_image4" class="img-thumbnail mx-auto d-block" draggable="false" alt="4" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"/>
                                            </div>
                                            <div id="div_expert_image5" class="col-4 img_container expert">
                                                <img id="expert_image5" class="img-thumbnail mx-auto d-block" draggable="false" alt="4" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"/>
                                            </div>
                                            <div id="div_expert_image6" class="col-4 img_container expert">
                                                <img id="expert_image6" class="img-thumbnail mx-auto d-block" draggable="false" alt="4" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"/>
                                            </div>
                                        </div>
                                        <div class="row expert_drop_div">
                                            <div id="div_expert_image7" class="col-4 img_container expert">
                                                <img id="expert_image7" class="img-thumbnail mx-auto d-block" draggable="false" alt="4" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"/>
                                            </div>
                                            <div id="div_expert_image8" class="col-4 img_container expert">
                                                <img id="expert_image8" class="img-thumbnail mx-auto d-block" draggable="false" alt="4" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"/>
                                            </div>
                                            <div id="div_expert_image9" class="col-4 img_container expert">
                                                <img id="expert_image9" class="img-thumbnail mx-auto d-block" draggable="false" alt="4" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="brown-container">
                            <div class="container">
                                <div class="row">

                                    <div class="col-sm-4 col-12">
                                        <div class="action_button button_container bg-info text-white">
                                            <div class="card-body" onclick="showInfo();">How to play</div>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 col-12">
                                        <div id="startGameButton" class="action_button button_container bg-info text-white">
                                            <div class="card-body">Start Game</div>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 col-12">
                                        <div id="helpMeButton" class="action_button button_container bg-info text-white">
                                            <div class="card-body">Help Me!</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-lg-1 col-xl-2">
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div class="col-md-1 col-lg-1">
    </div>
</div>
</div>
</div>

<!-- The Modal -->
<div class="modal fade" id="myModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Modal Heading</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                Modal body..
            </div>
            <!-- Modal footer -->
            <div class="modal-footer">
                <button id="modalCloseButton" type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="highscoremodal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Wowwowwie!!!</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form id="inputs" class="needs-validation" onsubmit="return setLastPerfectScore();">
                <!-- Modal body -->
                <div class="modal-body">
                    You got a perfect score!!! Adding you to the hall of fame..
                    Please enter your initials..

                    <div class="form-group mx-2 mb-3">
                        <label for="initials">Initials</label>
                        <input type="text" class="form-control" id="initials" placeholder="initials" required maxlength="3">
                    </div>

                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <input class="btn btn-danger" id="submit-button" type="submit" value="SUBMIT">

                    <!--                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Submit</button>-->
                </div>
            </form>
        </div>
    </div>
</div>

</body>
</html>